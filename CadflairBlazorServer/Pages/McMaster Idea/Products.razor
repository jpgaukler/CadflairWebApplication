@using Row = CadflairDataAccess.Models.Row;

@page "/{CompanyName}/products/{ProductDefinitionName}"
@layout ConfiguratorLayout

<PageTitle>@CompanyName - Categories</PageTitle>

<MudDrawerContainer Class="mud-height-full relative">

    <!-- sidebar -->
    <MudHidden Breakpoint="Breakpoint.MdAndDown">
        <MudDrawer @bind-Open="@_drawerOpen" Anchor="Anchor.Left" Elevation="1" Variant="DrawerVariant.Persistent" Width="300px">
            <!-- filters -->
            <MudStack Class="pa-3">
                <MudText Typo="Typo.body1"><strong>Filter by</strong></MudText>
                @foreach (var column in _productTable.Columns)
                {
                    <MudSelect T="string" SelectedValuesChanged="(values) => ColumnFilter_OnSelect(column, values)"
                           Label="@column.Header" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable MultiSelection>
                        @foreach (var tableValue in _productTable.Rows.Select(i => i.TableValues.First(i => i.ColumnId == column.Id)).DistinctBy(i => i.Value))
                        {
                            <MudSelectItem Value="tableValue.Value">@tableValue.Value</MudSelectItem>
                        }
                    </MudSelect>
                }
            </MudStack>
        </MudDrawer>
    </MudHidden>

    <MudStack Class="mud-height-full px-5 pt-3 overflow-auto relative">
        <MudOverlay Visible="_initializing" Absolute Class="mud-background">
            <MudProgressCircular Color="Color.Default" Size="Size.Large" Indeterminate />
        </MudOverlay>

        <MudStack Class="flex-grow-1 overflow-auto">
            <MudStack Row AlignItems="AlignItems.Center">
                <ThumbnailImage Uri="@_productDefinition?.ThumbnailUri" Height="200" Width="200" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4">@_productDefinition?.Name</MudText>
                    <MudText Typo="Typo.body1">@_productDefinition?.Description</MudText>
                    <MudText Typo="Typo.caption" Align="Align.Left">Count: @_productTable.Rows.Count</MudText>
                </MudStack>
            </MudStack>
            <!-- products -->
            <MudStack>
                <MudTable Items="_productTable.Rows.Where(_filter)" Outlined>
                    <NoRecordsContent>
                        <MudText>No products.</MudText>
                    </NoRecordsContent>
                    <HeaderContent>
                        <MudTh Style="min-width:15ch;">Part Number</MudTh>
                        @*<MudTh Style="min-width:15ch;"><MudTableSortLabel SortBy="new Func<Row, object>(x => x.PartNumber)">Part Number</MudTableSortLabel></MudTh>*@
                        @foreach (var column in _productTable.Columns)
                        {
                            <MudTh Style="min-width:15ch;">@column.Header</MudTh>
                            @*<MudTh Style="min-width:15ch;"><MudTableSortLabel SortBy="new Func<Row, object>(x => x.TableValues.FirstOrDefault(i => i.ColumnId == column.Id)?.Value!)">@column.Header</MudTableSortLabel></MudTh>*@
                        }
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Part Number">
                            <MudLink OnClick="() => _selectedRow = context">@context.PartNumber</MudLink>
                            <MudPopover Open="_selectedRow == context" AnchorOrigin="Origin.TopLeft" TransformOrigin="Origin.TopLeft" Class="ma-2">
                                <div class="d-flex flex-column pa-3" style="min-width:400px;">
                                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText><strong>@context.PartNumber</strong></MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="() => _selectedRow = null" Size="Size.Small" />
                                    </MudStack>
                                    @if (context.Attachments.Any())
                                    {
                                        <MudText Typo="Typo.body2">Product Detail</MudText>
                                        <MudSelect T="Attachment">
                                            @foreach(var attachment in context.Attachments)
                                            {
                                                <MudSelectItem Value="attachment">@attachment.ForgeObjectKey</MudSelectItem>
                                            }
                                            <MudButton StartIcon="@Icons.Material.Filled.Download" OnClick="() => Download_OnClick(_productDefinition!.ForgeBucketKey, context.Attachments.First().ForgeObjectKey)" />
                                        </MudSelect>
                                    }
                                </div>
                            </MudPopover>
                        </MudTd>
                        @foreach (var column in _productTable.Columns)
                        {
                            <MudTd DataLabel="@column.Header">@context.TableValues.FirstOrDefault(i => i.ColumnId == column.Id)?.Value</MudTd>
                        }
@*                        <MudTd>
                            <MudButton StartIcon="@Icons.Material.Filled.RemoveRedEye" OnClick="() => Preview_OnClick(context.Attachments.First().ForgeObjectKey)">Preview</MudButton>
                            <MudIconButton Icon="@Icons.Material.Filled.Download" OnClick="() => Download_OnClick(_productDefinition!.ForgeBucketKey, context.Attachments.First().ForgeObjectKey)" />
                        </MudTd>
*@                    </RowTemplate>
                </MudTable>
            </MudStack>
        </MudStack>
    </MudStack>
</MudDrawerContainer>

