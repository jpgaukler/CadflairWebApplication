@using System.Text.Json

@page "/productcatalog"
@layout ConfiguratorLayout
@inject IJSRuntime _js
@inject ForgeServicesManager _forgeServicesManager

<!--Drawer-->
<MudDrawer @bind-Open="@_drawerOpen"
           Variant="@DrawerVariant.Persistent"
           ClipMode="DrawerClipMode.Always"
           Anchor="Anchor.Left"
           Width="30%">
    <!--Drawer Header-->
    <MudDrawerHeader>
        <MudText Typo="Typo.h5"><b>@_formElements.Name</b></MudText>
    </MudDrawerHeader>
    <!--Drawer Content-->
    <MudStack Class="flex-grow-1 overflow-auto" Spacing="0">
        <!--Form Inputs-->
        <MudForm @bind-IsValid="_validInputs" Class="flex-grow-1 overflow-auto">
            <MudStack Class="flex-grow-1 px-3 overflow-auto">
                @if (_formElements.Items != null)
                {
                    @foreach (ILogicUiElement element in _formElements.Items)
                    {
                        <ProductInput Element="@element" @key="element"></ProductInput>
                    }
                }
            </MudStack>
        </MudForm>

        <!--Buttons-->
        <MudStack Class="pa-3">
            <MudButton OnClick="PrintInputValues" Disabled="@(!_validInputs)" Variant="@_buttonVariant" Color="Color.Primary" FullWidth="true">Submit</MudButton>
            <MudButton Variant="@_buttonVariant" Color="Color.Primary" FullWidth="true">Download Pdf</MudButton>
            <MudButton Variant="@_buttonVariant" Color="Color.Primary" FullWidth="true">Download Step</MudButton>
        </MudStack>
    </MudStack>
</MudDrawer>

<!--Collapse Button-->
<MudStack Class="d-flex flex-row absolute z-10 ma-1">
    <MudToggleIconButton @bind-Toggled="@_drawerOpen"
                         Variant="Variant.Filled"
                         Style="border-radius:50%"
                         Icon="@Icons.Filled.ChevronRight" Color="@Color.Primary" Size="Size.Large"
                         ToggledIcon="@Icons.Filled.ChevronLeft" ToggledColor="@Color.Primary" ToggledSize="Size.Large" />

</MudStack>

<!--Viewer-->
<div class="d-flex ma-0 pa-0" style="height: calc(100vh - var(--mud-appbar-height))">
    <ForgeViewer />
</div>


@code
{
    private Variant _buttonVariant = Variant.Outlined;
    private bool _drawerOpen = true;
    private ILogicUiElement _formElements = new();
    private bool _validInputs;

    protected override void OnInitialized()
    {

        //look at the url to find the corresponding product, then read the data from the database


        string folderName = @"C:\Users\jpgau\source\repos\jpgaukler\CadflairWebApplication\Inventor Files";

        if (!Directory.Exists(folderName))
        {
            folderName = @"C:\Users\Admin\source\repos\CadflairWebApplication\Inventor Files";
        }

        string fileName = Path.Combine(folderName, "Dresser Parameters 1.json");
        string jsonText = System.IO.File.ReadAllText(fileName);
        Debug.WriteLine(jsonText);

        _formElements = JsonSerializer.Deserialize<ILogicUiElement>(jsonText);
    }

    //private async Task CreateBucket()
    //{
    //    await _objectStorageService.CreateBucketAsync(Guid.NewGuid().ToString());
    //}

    private async Task PrintInputValues()
    {
        var values = GetInputValues(_formElements.Items);

        //foreach(var val in values)
        //{
        //    Debug.WriteLine($"{val.Key}: {val.Value}");
        //}

        string jsonValues = JsonSerializer.Serialize(values);
        Debug.WriteLine(jsonValues);


        //submit the request to design automation. I just want to make the model and convert it to svf here. Do not produce any inputs yet
        await _forgeServicesManager.DesignAutomationService.GenerateProductConfiguration("cadflair.dresserbasemodel", "Dresser.zip", "Dresser Configurator.ipt", jsonValues);

        //need to remember to create the output bucket before submitting the request. The workitem will fail if the output bucket does not exist

        //somehow get the callback when the workitem is done, then create a new row in the database table so this can be looked up later

        //show buttons for generating outputs if the user likes what they see (pdf, dwg, dwf, stp)
    }

    private Dictionary<string, string> GetInputValues(List<ILogicUiElement> items, Dictionary<string, string>? values = null)
    {
        if (values == null) values = new();

        foreach(ILogicUiElement item in items)
        {
            if (item.ParameterName != null && !values.ContainsKey(item.ParameterName)) values.Add(item.ParameterName, item.ParameterExpression);
            if (item.Items != null) GetInputValues(item.Items, values);
        }

        return values;
    }

}
