@page "/dashboard"
@attribute [Authorize]
@inject AuthenticationStateProvider _authenticationStateProvider
@inject DataServicesManager _dataServicesManager

<PageTitle>Cadflair</PageTitle>

<!--pop-up to start a new free trial if no subscription is found for the user-->
<MudPopover Open="@_showGetStarted" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.CenterCenter" Delay="500">
    <MudOverlay Visible="true" DarkBackground="true" AutoClose="false">
        <MudPaper>
            <MudStack AlignItems="AlignItems.Center" Class="pa-5">
                <MudText Typo="Typo.h4">Welcome to Cadflair</MudText>
                <MudText Typo="Typo.body1">Start your <b>30 day free trial</b> to begin!</MudText>
                <MudButton Link="/subscription/new" Variant="Variant.Filled" Color="Color.Primary">Get Started</MudButton>
            </MudStack>
        </MudPaper>
    </MudOverlay>
</MudPopover>


<MudText Typo="Typo.h2">Dashboard</MudText>
<MudText>Hello @_loggedInUser.FullName</MudText>
<MudText Typo="Typo.h4">Company: @_subscription.CompanyName</MudText>

<ProductFolderTree/>

<MudLink Href="/productcatalog">Catalog</MudLink>

@code {

    private bool _showGetStarted = false;
    private User _loggedInUser = new();
    private Subscription _subscription = new();

    protected override async Task OnInitializedAsync()
    {
        _loggedInUser = await _authenticationStateProvider.GetUser(_dataServicesManager.UserService);

        if (_loggedInUser.SubscriptionId == null)
        {
            _showGetStarted = true;
            return;
        }

        _subscription = await _dataServicesManager.SubscriptionService.GetSubscriptionById((int)_loggedInUser.SubscriptionId!) ?? new();
    }

}
